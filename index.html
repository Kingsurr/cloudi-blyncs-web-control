<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOUDI-BLYNCS | Kontrol ESP32</title>
    
    <style>
        /* --- CSS STYLING --- */
        
        :root {
            /* Warna Dasar */
            --bg-page: #f0f8ff; 
            --bg-card: #e6f0f7;
            --primary-color: #007bff;
            --secondary-color: #6f42c1;
            --success-color: #20c997;
            --danger-color: #e83e8c;
            --warning-color: #fd7e14;
            --text-dark: #344767;
            
            /* Shadow yang Lebih Halus */
            --shadow-light: -4px -4px 8px #ffffff, 4px 4px 8px #d8e6f0; 
            --shadow-inset: inset 2px 2px 5px #d8e6f0, inset -3px -3px 7px #ffffff;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            background-color: var(--bg-page);
            margin: 0;
            padding: 10px;
            color: var(--text-dark);
            min-height: 100vh;
            position: relative; 
        }
        
        /* Gaya untuk Logo (Pojok Kiri Atas) */
        .header-logo {
            position: absolute;
            top: 20px; 
            left: 20px; 
            width: 80px; 
            height: auto;
            z-index: 10;
            opacity: 0.8; 
            /* pointer-events: none; - Dihapus agar bisa di-klik atau di-drag jika perlu */
        }

        h1 {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 800;
            letter-spacing: 1px;
            padding-top: 20px; /* Tambahkan padding atas agar tidak tertutup logo */
        }
        
        h2 {
            color: var(--primary-color);
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 18px;
            box-shadow: 10px 10px 20px #c6cfd8, -10px -10px 20px #ffffff; 
        }
        
        .control-group {
            margin-bottom: 18px;
            padding: 15px;
            border-radius: 12px;
            background-color: var(--bg-card);
            box-shadow: var(--shadow-light); 
        }
        
        /* Tata Letak untuk Input dan Slider */
        .input-control-label {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 8px;
             font-weight: 600;
             font-size: 0.95em;
        }
        .input-control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        /* Input Number Styling */
        .number-input {
            width: 60px;
            padding: 8px 5px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card);
            box-shadow: var(--shadow-inset);
            text-align: right;
            font-weight: 600;
            color: var(--text-dark);
            -moz-appearance: textfield; 
            margin-left: 5px;
        }
        /* Sembunyikan panah di Chrome/Safari */
        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* SLIDER STYLING */
        input[type="range"] {
            flex-grow: 1;
            height: 8px; 
            background: #d9dce0;
            border-radius: 4px;
            box-shadow: var(--shadow-inset); 
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; 
            height: 20px;
            background: var(--primary-color);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
            border: 4px solid var(--bg-card); 
            cursor: pointer;
            border-radius: 50%;
            margin-top: -6px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; 
            height: 20px;
            background: var(--primary-color);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
            border: 4px solid var(--bg-card); 
            cursor: pointer;
            border-radius: 50%;
        }


        /* BUTTON STYLING */
        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 10px; 
            margin-top: 15px;
        }

        .btn {
            flex-grow: 1; 
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 700;
            text-align: center;
            box-shadow: 3px 3px 6px #c6cfd8, -3px -3px 6px #ffffff; 
            transition: all 0.1s;
            border: none;
            cursor: pointer;
            color: white; 
            user-select: none; /* Cegah teks terpilih saat menekan tombol cepat */
        }
        
        /* Palet Warna Tombol */
        .btn-primary { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--warning-color); color: var(--text-dark); }
        .btn-info { background-color: #adb5bd; color: var(--text-dark); }
        
        /* Efek Tombol */
        .btn:active {
            box-shadow: var(--shadow-inset); 
        }

        /* DISPLAY & STATUS */
        #status-display {
            padding: 15px;
            font-weight: 800;
            font-size: 1.2em;
            color: var(--secondary-color);
            box-shadow: var(--shadow-inset); 
            background: #d4e8f9;
            text-align: center;
            border-radius: 8px;
        }
        
        #connection-status {
            font-size: 0.95em; 
            padding: 10px; 
            font-weight: 700;
            box-shadow: var(--shadow-inset);
            border-radius: 8px;
        }
        .status-online { background-color: #d8f5ee; color: var(--success-color); }
        .status-offline { background-color: #ffe6f0; color: var(--danger-color); }

        /* --- MEDIA QUERIES UNTUK RESPONSIVE --- */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .header-logo {
                top: 10px;
                left: 10px;
                width: 60px; 
            }
            .container {
                padding: 15px;
                border-radius: 15px;
                box-shadow: 5px 5px 10px #c6cfd8, -5px -5px 10px #ffffff;
            }
            h1 {
                font-size: 1.6em;
                margin-bottom: 15px;
            }
            .control-group {
                padding: 10px;
                margin-bottom: 15px;
            }
            .number-input {
                width: 50px;
                padding: 6px 4px;
                font-size: 0.9em;
            }
            input[type="range"] {
                 height: 6px;
            }
            .btn {
                 padding: 10px 10px;
                 font-size: 0.85em;
            }
        }

    </style>

</head>
<body>
    
    <img src="Lambang-UM.webp" alt="Logo UM" class="header-logo"> 
    
    <div class="container">
        <h1>CLOUDI-BLYNCS</h1>
        
        <div class="control-group" style="text-align: center;">
            <div class="input-control-label" style="justify-content: center;">Status Perangkat ESP32</div>
            <div id="connection-status">
                Memeriksa koneksi...
            </div>
        </div>
        
        <div class="control-group">
            <div class="input-control-label"> Daya Dimmer (V0): 
                <span id="power-value-display">0</span>
                <span class="unit-text">%</span>
            </div>
            <div class="input-control-row">
                <input type="range" id="power-slider" min="0" max="100" value="0" 
                    oninput="syncValue('power', 'slider', this.value)" 
                    onchange="updateBlynkPin('v0', this.value)">
                <input type="number" id="power-input" class="number-input" min="0" max="100" value="0" 
                    oninput="syncValue('power', 'input', this.value)" 
                    onblur="syncAndSend('power', 'input', this.value)">
            </div>
        </div>

        <div class="control-group">
            <div class="input-control-label" style="justify-content: center;">Mode Daya Penuh (V3)</div>
            <button class="btn btn-info" id="full-power-btn" onclick="toggleFullPower()">OFF</button>
        </div>

        <div class="control-group">
            <div class="input-control-label"> Lebar Pulsa Gate (V1): 
                <span id="pulse-value-display">1200</span> 
                <span class="unit-text"> $\mu$s</span> 
            </div>
            <div class="input-control-row">
                <input type="range" id="pulse-slider" min="200" max="4000" step="1" value="1200" 
                    oninput="syncValue('pulse', 'slider', this.value)" 
                    onchange="updateBlynkPin('v1', this.value)">
                <input type="number" id="pulse-input" class="number-input" min="200" max="4000" step="1" value="1200" 
                    oninput="syncValue('pulse', 'input', this.value)" 
                    onblur="syncAndSend('pulse', 'input', this.value)">
            </div>
        </div>

        <div class="control-group">
            <div class="input-control-label" style="justify-content: center;">Uji Pulsa Gate (V2)</div>
            <button class="btn btn-secondary" onmousedown="sendPulse('v2', 1)" onmouseup="sendPulse('v2', 0)">FIRE (Tekan & Tahan)</button>
        </div>
        
        <div class="control-group">
            <h2>Kontrol Timer</h2>
            
            <div class="input-control-label"> Durasi Timer (V4): 
                <span id="timer-value-display">0</span> 
                <span class="unit-text"> Menit</span>
            </div>
            <div class="input-control-row">
                <input type="range" id="timer-slider" min="0" max="60" step="1" value="0" 
                    oninput="syncValue('timer', 'slider', this.value)" 
                    onchange="updateBlynkPin('v4', this.value)">
                <input type="number" id="timer-input" class="number-input" min="0" max="60" step="1" value="0" 
                    oninput="syncValue('timer', 'input', this.value)" 
                    onblur="syncAndSend('timer', 'input', this.value)">
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" onclick="startTimer()">Start Timer (V5)</button>
                <button class="btn btn-danger" onclick="stopTimer()">Stop Timer (V7)</button>
            </div>

            <div class="input-control-label" style="margin-top: 15px; justify-content: center;">Status Timer (V6)</div>
            <div id="status-display">Ready</div>
        </div>

    </div>

    <script>
        // --- JAVASCRIPT (Logika Kontrol & Sinkronisasi) ---
        
        // GANTI INI DENGAN AUTH TOKEN BLYNK ANDA
        const BLYNK_AUTH_TOKEN = "KUJWMkmFarXyPL2FUxReLa7-GNsupY0f"; 
        const BLYNK_API_URL = "https://blynk.cloud/external/api/";

        let isFullPowerOn = false;

        // FUNGSI UMUM UNTUK MENGIRIM NILAI KE PIN VIRTUAL
        function updateBlynkPin(pin, value) {
            if (isNaN(value) || value === "") return;

            const url = `${BLYNK_API_URL}update?token=${BLYNK_AUTH_TOKEN}&${pin}=${value}`;
            
            fetch(url)
                .then(response => {
                    // Blynk API biasanya merespon 200 OK bahkan tanpa body.
                    if (!response.ok) {
                        console.error(`Gagal update ${pin}. Status: ${response.status}`);
                    } else {
                        console.log(`${pin} updated successfully with value: ${value}`);
                    }
                })
                .catch(error => console.error(`Error updating ${pin}:`, error));
        }

        // Memastikan nilai input berada dalam batas min/max, dan memanggil updateBlynkPin
        function syncAndSend(name, source, value) {
            const input = document.getElementById(`${name}-input`);
            
            // 1. Enforce Min/Max
            let numericValue = parseFloat(value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (isNaN(numericValue)) {
                // Jika input kosong atau tidak valid saat blur, kembalikan ke nilai slider/default
                input.value = document.getElementById(`${name}-slider`).value;
                numericValue = parseFloat(input.value);
            } else if (numericValue < min) {
                numericValue = min;
                input.value = min;
            } else if (numericValue > max) {
                numericValue = max;
                input.value = max;
            }

            // 2. Sinkronkan tampilan dan slider
            syncValue(name, source, numericValue);
            
            // 3. Kirim ke Blynk
            const pinMap = { 'power': 'v0', 'pulse': 'v1', 'timer': 'v4' };
            updateBlynkPin(pinMap[name], numericValue);
        }
        
        // Fungsi untuk menyinkronkan nilai antara slider, input, dan display
        function syncValue(name, source, value) {
            const slider = document.getElementById(`${name}-slider`);
            const input = document.getElementById(`${name}-input`);
            const display = document.getElementById(`${name}-value-display`);
            
            let numericValue = parseFloat(value);
            
            if (isNaN(numericValue)) {
                 // Jika tidak ada nilai, tampilkan placeholder
                display.textContent = "___";
                return;
            }

            // Sinkronisasi
            if (source === 'input') {
                slider.value = numericValue;
            } else if (source === 'slider') {
                input.value = numericValue;
            }
            
            display.textContent = numericValue;
        }
        
        // --- FUNGSI KHUSUS BLYNK ---

        function toggleFullPower() {
            isFullPowerOn = !isFullPowerOn;
            const value = isFullPowerOn ? 1 : 0;
            const btn = document.getElementById('full-power-btn');
            
            btn.textContent = isFullPowerOn ? "ON" : "OFF";
            if (isFullPowerOn) {
                btn.classList.remove('btn-info');
                btn.classList.add('btn-danger'); // Merah untuk ON (Aktif)
            } else {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-info'); // Abu-abu untuk OFF
            }
            
            updateBlynkPin('v3', value);
        }
        
        // Mengirim 1 pada mousedown dan 0 pada mouseup
        function sendPulse(pin, value) {
            updateBlynkPin(pin, value);
        }
        
        function startTimer() {
            // Mengirim 1, lalu cepat kembali ke 0 (simulasi tombol push)
            updateBlynkPin('v5', 1);
            setTimeout(() => updateBlynkPin('v5', 0), 200);
            document.getElementById('status-display').textContent = "TIMER STARTING...";
        }

        function stopTimer() {
            // Mengirim 1, lalu cepat kembali ke 0 (simulasi tombol push)
            updateBlynkPin('v7', 1);
            setTimeout(() => updateBlynkPin('v7', 0), 200);
            document.getElementById('status-display').textContent = "TIMER STOPPING...";
        }

        // FUNGSI INI DIPERBAIKI UNTUK MENGATASI JSON ERROR DARI BLYNK
        function readBlynkV6() {
            const url = `${BLYNK_API_URL}get?token=${BLYNK_AUTH_TOKEN}&v6`;
            
            fetch(url)
                .then(response => response.text()) // Ambil response sebagai TEXT, bukan JSON
                .then(textData => {
                    // Bersihkan tanda kurung siku dan quotes yang mungkin ada dari Blynk
                    const statusText = textData.trim().replace(/[\[\]"]/g, ''); 
                    document.getElementById('status-display').textContent = statusText || "Status Tidak Dikenal";
                })
                .catch(error => {
                    console.error('Error reading V6:', error);
                    document.getElementById('status-display').textContent = "⚠️ ERROR API";
                });
        }
        
        // Membaca status koneksi perangkat keras
        function readConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            const url = `${BLYNK_API_URL}isHardwareConnected?token=${BLYNK_AUTH_TOKEN}`;

            fetch(url)
                .then(response => response.json())
                .then(isConnected => {
                    statusElement.classList.remove('status-online', 'status-offline');
                    
                    if (isConnected === true) {
                        statusElement.textContent = "✅ ONLINE: ESP32 Terhubung ke Blynk Cloud";
                        statusElement.classList.add('status-online');
                    } else {
                        statusElement.textContent = "❌ OFFLINE: ESP32 Tidak Terhubung";
                        statusElement.classList.add('status-offline');
                    }
                })
                .catch(error => {
                    console.error('Error checking connection status:', error);
                    statusElement.textContent = "⚠️ ERROR API: Gagal memeriksa status koneksi.";
                    statusElement.classList.add('status-offline');
                });
        }

        // --- INISIALISASI ---

        // Panggil status koneksi lebih sering (10s) dan status timer (3s)
        setInterval(readBlynkV6, 3000); 
        setInterval(readConnectionStatus, 10000);
        readBlynkV6();
        readConnectionStatus(); 
        
    </script>
</body>
</html>